"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[4483],{3905:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return h}});var o=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},i=Object.keys(e);for(o=0;o<i.length;o++)a=i[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)a=i[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=o.createContext({}),d=function(e){var t=o.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},p=function(e){var t=d(e.components);return o.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=d(a),h=n,m=u["".concat(l,".").concat(h)]||u[h]||c[h]||i;return a?o.createElement(m,r(r({ref:t},p),{},{components:a})):o.createElement(m,r({ref:t},p))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,r=new Array(i);r[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:n,r[1]=s;for(var d=2;d<i;d++)r[d]=a[d];return o.createElement.apply(null,r)}return o.createElement.apply(null,a)}u.displayName="MDXCreateElement"},5546:function(e,t,a){a.r(t),a.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return c}});var o=a(7462),n=a(3366),i=(a(7294),a(3905)),r=["components"],s={sidebar_position:96},l="Android Auto Support",d={unversionedId:"guides/android-auto",id:"guides/android-auto",title:"Android Auto Support",description:"Make sure to read through Google's guidelines before adding Android Auto support to your RNTP app! Not all features in the article are implemented so PRs are always welcome. Also do note this lib has migrated to media3 and Android Auto still refers to the exoplayer2 implementation. For any questions please harass the media3 team instead.",source:"@site/docs/guides/android-auto.md",sourceDirName:"guides",slug:"/guides/android-auto",permalink:"/docs/next/guides/android-auto",editUrl:"https://github.com/doublesymmetry/react-native-track-player/tree/main/docs/docs/guides/android-auto.md",tags:[],version:"current",sidebarPosition:96,frontMatter:{sidebar_position:96},sidebar:"app",previous:{title:"Play Buttons",permalink:"/docs/next/guides/play-button"},next:{title:"Crossfade",permalink:"/docs/next/guides/crossfade"}},p={},c=[{value:"Concept",id:"concept",level:2},{value:"RN Version Compatibility",id:"rn-version-compatibility",level:2},{value:"Necessary Declarations",id:"necessary-declarations",level:2},{value:"Content Hierarchy",id:"content-hierarchy",level:2},{value:"Fetching Contents",id:"fetching-contents",level:2},{value:"Event Callback",id:"event-callback",level:2},{value:"Headless Start",id:"headless-start",level:2},{value:"Album Art",id:"album-art",level:2},{value:"Known Issues",id:"known-issues",level:2},{value:"App Showcase",id:"app-showcase",level:2}],u={toc:c};function h(e){var t=e.components,a=(0,n.Z)(e,r);return(0,i.kt)("wrapper",(0,o.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"android-auto-support"},"Android Auto Support"),(0,i.kt)("p",null,"Make sure to read through ",(0,i.kt)("a",{parentName:"p",href:"https://developer.android.com/training/cars/media"},"Google's guidelines")," before adding Android Auto support to your RNTP app! Not all features in the article are implemented so PRs are always welcome. Also do note this lib has migrated to media3 and Android Auto still refers to the exoplayer2 implementation. For any questions please ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/androidx/media/issues"},"harass the media3 team")," instead."),(0,i.kt)("p",null,"See the example app and ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/podverse/podverse-rn/pull/1928"},"Podverse's PR")," as examples adding Android Auto support to an existing RNTP app."),(0,i.kt)("h2",{id:"concept"},"Concept"),(0,i.kt)("p",null,"You can see how my idea went to implementation in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/doublesymmetry/react-native-track-player/discussions/1984"},"this discussion"),". In short, the HeadlessJsTaskService in RN's repository is copied out and manually tuned to extend MediaLibraryService instead of Service."),(0,i.kt)("h2",{id:"rn-version-compatibility"},"RN Version Compatibility"),(0,i.kt)("p",null,"HeadlessJsTaskService.java does change across RN versions, for example from RN 0.71. RNTP's HeadlessJsTaskService will use whatever compatible with the most recent RN version. You may need to manually edit HeadlessJsMediaService.java to make it compatible with your current RN version. See ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/lovegaoshi/react-native-track-player/tree/dev-podverse-aa"},"Podverse's RNTP fork")," that uses RN 0.66."),(0,i.kt)("p",null,"I can only guarantee specifically this lib's compatibility is to whatever ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/lovegaoshi/azusa-player-mobile"},"APM")," uses, which is almost always only the newest."),(0,i.kt)("h2",{id:"necessary-declarations"},"Necessary Declarations"),(0,i.kt)("p",null,"Enable Google voice assistant permissions (must be implemented per Google's AA guidelines) in your project's AndroidManifest.xml by adding this below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'            <intent-filter>\n                <action android:name="android.media.action.MEDIA_PLAY_FROM_SEARCH" />\n                <category android:name="android.intent.category.DEFAULT" />\n            </intent-filter>\n')),(0,i.kt)("p",null,"Then add Android Auto declarations as so:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'        <meta-data android:name="com.google.android.gms.car.application"\n            android:resource="@xml/automotive_app_desc"/>\n')),(0,i.kt)("p",null,"Make ",(0,i.kt)("inlineCode",{parentName:"p"},"automotive_app_desc.xml")," under your project's ",(0,i.kt)("inlineCode",{parentName:"p"},"android/src/main/res/xml")," with the content below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'<automotiveApp>\n    <uses name="media"/>\n</automotiveApp>\n')),(0,i.kt)("p",null,"Lastly enable any app to show in Android Auto via Settings -> Apps -> Android Auto -> In-App Notification Settings -> vertical dot on the top right corner -> Developer Settings -> Unknown Sources. This is necessary for any app not in the play store yet."),(0,i.kt)("p",null,"This will immediately enable your RNTP app to have synced media control in Android Auto."),(0,i.kt)("h2",{id:"content-hierarchy"},"Content Hierarchy"),(0,i.kt)("p",null,"Android Auto can show ",(0,i.kt)("inlineCode",{parentName:"p"},"playable")," (songs) and ",(0,i.kt)("inlineCode",{parentName:"p"},"browsable")," (playlists) ",(0,i.kt)("inlineCode",{parentName:"p"},"MediaItem"),"s. These MediaItems are organized like a tree structure, starting from the root branching out. In addition, ",(0,i.kt)("inlineCode",{parentName:"p"},"browsable")," MediaItems at the root level will become tabs shown at the top. AA supports a maximum of 4 tabs."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"MediaItem")," must have a ",(0,i.kt)("inlineCode",{parentName:"p"},"Title"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"mediaID")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"playable")," field. In addition, ",(0,i.kt)("inlineCode",{parentName:"p"},"Subtitle")," (artist) and ",(0,i.kt)("inlineCode",{parentName:"p"},"iconUri")," (album art) can be specified."),(0,i.kt)("p",null,"AA content hierarchy is a dict with ",(0,i.kt)("inlineCode",{parentName:"p"},"mediaID"),"s as keys and a list of ",(0,i.kt)("inlineCode",{parentName:"p"},"MediaItem"),"s as values. See the demo hierarchy here."),(0,i.kt)("h2",{id:"fetching-contents"},"Fetching Contents"),(0,i.kt)("p",null,"Contents can be refreshed by repeatly calling TrackPlayer.setBrowseTree. Sometimes you do not want to load your contents all at once to the browseTree, say because it's quite heavy on internet connections. You may programmatically load data via ",(0,i.kt)("inlineCode",{parentName:"p"},"Event.RemoteBrowse")," that returns the browsable mediaItem's ",(0,i.kt)("inlineCode",{parentName:"p"},"mediaID")," a user has clicked. Then you can update content as above and AA will work as so. See Podverse."),(0,i.kt)("p",null,"Because content refresh triggers MediaBrowserService.notifyChildrenChange, this effectively triggers RemoteBrowse again; there is evidence all tabs are triggered this way, not leaves. so if you do not set a caching system to prevent this from loading, add a debounce check. But do not use a debounce hook. See Podverse."),(0,i.kt)("h2",{id:"event-callback"},"Event Callback"),(0,i.kt)("p",null,"Android Auto requires 3 events to be handled: ",(0,i.kt)("inlineCode",{parentName:"p"},"Event.RemotePlayId")," ",(0,i.kt)("inlineCode",{parentName:"p"},"Event.RemotePlaySearch")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"Event.RemoteSkip"),". ",(0,i.kt)("inlineCode",{parentName:"p"},"Event.RemotePlayId")," is emitted when users click playable items in AA's content hierarchy. ",(0,i.kt)("inlineCode",{parentName:"p"},"Event.RemotePlaySearch")," is emitted when users use google voice assistant in Android Auto, which must be implemented per Google's AA guidelines. ",(0,i.kt)("inlineCode",{parentName:"p"},"Event.RemoteSkip"),' is responsible for playback from users clicking in the "queue" list from the top right corner. This should be handled as ',(0,i.kt)("inlineCode",{parentName:"p"},"TrackPlayer.skip(event.index).then(() => TrackPlayer.play());"),"."),(0,i.kt)("h2",{id:"headless-start"},"Headless Start"),(0,i.kt)("p",null,"Since media3, MusicService is now automatically started by the system/MediaLibraryService and allows a better headless implementation. This may be applicable to the old exoplayer2 implementation, but I'm not bothered to check. What's important is now MusicService will wake the js entry point, executes everything in index.js, but do NOT render the view. Thus any registered callbacks work (eg. registerHeadlessTask), but hooks do not."),(0,i.kt)("p",null,"For a clean headless start implementation, the app initialization and specifically PlayFromSearch and PlayFromMediaId events have to be handled outside of a hook. Please refer to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/lovegaoshi/azusa-player-mobile/pull/566"},"APM's PR")," for an example."),(0,i.kt)("p",null,"Below is the old wake Activity implementation."),(0,i.kt)("p",null,"Android Auto only starts the MediaBrowserCompactService, not the activity of your app. RNTP itself does separate its Service (MusicService) from Activity (RN App), however because RNTP has to be initialized in the RN side, technically it is not possible to start Android Auto without starting the RN Activity. With a native android app, one would refactor all logic into MusicService and leave Activity only showing the UI, but this is not possible for RN apps. There are workarounds:"),(0,i.kt)("p",null,'You must enable some way to start activity from a background service. The easiest one is to enable android.permission.SYSTEM_ALERT_WINDOW and ask your users to enable "draw over other apps." This will trigger the app to start when RNActivity is either isDestoryed() or not exist, and the service waking it is in the whitelist (android auto and systemui). Your app will be automatically brought to foreground.'),(0,i.kt)("p",null,"You may also have noticed Android Activities cannot start when the screen is locked/off. This is an intended behavior of Android. The workaround is to enable in AndroidManifest.xml"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'            android:showOnLockScreen="true"\n            android:turnScreenOn="true"\n')),(0,i.kt)("p",null,"or add this in the onCreate function of RNActivity:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O_MR1) {\n      setShowWhenLocked(true);\n      setTurnScreenOn(true);\n    }\n")),(0,i.kt)("p",null,"This allows the RN Activity to overlay on top of the lock screen and start itself normally. However now the activity will always stay on top of the lock screen, meaning this app can be now used without unlocking. To work around this again, create a native module call to turn it off after your app is fully initialized."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O_MR1) {\n      setShowWhenLocked(false);\n      setTurnScreenOn(false);\n    }\n")),(0,i.kt)("h2",{id:"album-art"},"Album Art"),(0,i.kt)("p",null,"I originally enabled album art via ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/lovegaoshi/KotlinAudio/commit/7a3d90b5b7b548e45b8b54ffcf62eac5c795bc14"},"https://github.com/lovegaoshi/KotlinAudio/commit/7a3d90b5b7b548e45b8b54ffcf62eac5c795bc14")," but ",(0,i.kt)("a",{parentName:"p",href:"https://developer.android.com/training/cars/media/#display-artwork"},"google's guidelines")," seem to contradict with that. nevertheless however RNTP is currently set up (for ex ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/lovegaoshi/react-native-track-player/blob/6f634594f24aa1974b2c8cdc6848b8b349cccdf0/android/src/main/java/com/doublesymmetry/kotlinaudio/notification/NotificationManager.kt#L389"},"https://github.com/lovegaoshi/react-native-track-player/blob/6f634594f24aa1974b2c8cdc6848b8b349cccdf0/android/src/main/java/com/doublesymmetry/kotlinaudio/notification/NotificationManager.kt#L389"),") for remote urls it works great, but for local uris (file:///) and embedded covers within local media files it wont work."),(0,i.kt)("p",null,"for local uris while I do not have a use and no rigorous tests yet, I believe converting the file:/// uri to a content:// one, as specified in the google guidelines, would work. u can see how i did this via a fileProvider: ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/lovegaoshi/azusa-player-mobile/pull/449"},"https://github.com/lovegaoshi/azusa-player-mobile/pull/449")),(0,i.kt)("p",null,"for embedded covers this has to be first resolved and written to a file, then load the content:// uri as in the google guidelines. I tried with both ffmpeg and MediaMetadataRetriever, opted for the latter in the end for simplicity. commit is here: ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/lovegaoshi/react-native-track-player/commit/6f634594f24aa1974b2c8cdc6848b8b349cccdf0"},"https://github.com/lovegaoshi/react-native-track-player/commit/6f634594f24aa1974b2c8cdc6848b8b349cccdf0")),(0,i.kt)("p",null,"the specific implementation I have does have a drawback taht the local file is written in the /Pictures folder. you might be able to write to cache using File() then convert to content:// with a fileProvider, but I chose the simplicity of MediaStore and can deal with this drawback."),(0,i.kt)("h2",{id:"known-issues"},"Known Issues"),(0,i.kt)("p",null,"JumpForward and JumpBackward may not show on Android <13 devices. To resolve this, implement these buttons as CustomActions, just like how they are handled under Android >=13. You need to implement changes in KotlinAudio. Note this will introduce ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/doublesymmetry/react-native-track-player/issues/1970"},"duplicate custom actions buttons")," so more patches are needed. See Podverse's KotlinAudio fork."),(0,i.kt)("p",null,"If ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/lovegaoshi/react-native-track-player/issues/26"},"Event.RemoteBrowse is not firing for the first two tabs"),", you may need to reinstall android auto."),(0,i.kt)("h2",{id:"app-showcase"},"App Showcase"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://play.google.com/store/apps/details?id=com.noxplay.noxplayer"},"APM")," and ",(0,i.kt)("a",{parentName:"p",href:"https://play.google.com/store/apps/details?id=com.podverse"},"Podverse")," use a customized fork and are both on the google play store in production with auto support."),(0,i.kt)("p",null,"Getting pass Play Store's review process for an auto suppported app is tough. Here are a few issues we encountered:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Issue found: App doesn't perform as expected\n\nYour app does not perform all functions properly or as expected from a user perspective.\n\nFor example, your app does not load media content in Android Auto.\n")),(0,i.kt)("p",null,"This was due to APM never performed content updates via ",(0,i.kt)("inlineCode",{parentName:"p"},"TrackPlayer.setBrowseTree")," (albeit initializes) thoughout the app's lifecycle. I think a human tester intervened and expected what my app does."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/lovegaoshi/azusa-player-mobile/pull/209"},"https://github.com/lovegaoshi/azusa-player-mobile/pull/209")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"something about media not responsive to voice commands\n")),(0,i.kt)("p",null,"This was due to Podverse did not handle voice commands. Although play store refused to approve repeatly after fix until an appeal was submitted, then it was approved."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/podverse/podverse-rn/pull/1969"},"https://github.com/podverse/podverse-rn/pull/1969")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"your app does not respond after issuing a voice command.\n")),(0,i.kt)("p",null,"This is a recent rejection I experienced since this year and it could be JS bugs I accidentally introduced or now a native handler to MEDIA_PLAY_FROM_SEARCH is expected; but for the PR that fixed this as a reference, see ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/lovegaoshi/azusa-player-mobile/pull/407"},"https://github.com/lovegaoshi/azusa-player-mobile/pull/407")))}h.isMDXComponent=!0}}]);